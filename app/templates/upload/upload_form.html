{% extends "base.html" %}

{% block title %}Upload MOU - {{ mou.title }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/upload.css') }}">
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="card">
        <div class="card-header text-center">
            <h2>MOU Upload Portal</h2>
            <p class="text-muted">{{ mou.title }}</p>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <p><strong>From:</strong> {{ mou.party_a.name }}</p>
                <p><strong>To:</strong> {{ mou.party_b.name if mou.party_b else 'Your Organization' }}</p>
                <p><strong>Link expires on:</strong> {{ mou.link_expiry.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            </div>
            
            <form method="POST" enctype="multipart/form-data" id="uploadForm">
                <div class="mb-4">
                    <h5>Step 1: Upload MOU Document</h5>
                    <div class="mb-3">
                        <label for="mou_file" class="form-label">Select MOU PDF File</label>
                        <input class="form-control" type="file" id="mou_file" name="mou_file" accept=".pdf" required>
                        <div class="form-text">Only PDF files are accepted. Maximum size: 16MB.</div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5>Step 2: Add Your Signature</h5>
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="signature_type" id="signatureDraw" value="draw" checked>
                            <label class="form-check-label" for="signatureDraw">Draw Signature</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="signature_type" id="signatureUpload" value="upload">
                            <label class="form-check-label" for="signatureUpload">Upload Signature</label>
                        </div>
                    </div>
                    
                    <div id="signatureDrawContainer" class="mb-3">
                        <div class="signature-pad-container">
                            <canvas id="signatureCanvas" width="600" height="200" class="signature-pad"></canvas>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSignature">Clear</button>
                            <div class="form-text">Draw your signature above using your mouse or touch screen.</div>
                        </div>
                        <input type="hidden" name="signature_data" id="signatureData">
                    </div>
                    
                    <div id="signatureUploadContainer" class="mb-3" style="display: none;">
                        <label for="signature_file" class="form-label">Upload Signature Image</label>
                        <input class="form-control" type="file" id="signature_file" name="signature_file" accept=".png,.jpg,.jpeg">
                        <div class="form-text">Upload a PNG or JPG image of your signature.</div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5>Step 3: Submit</h5>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmCheck" required>
                        <label class="form-check-label" for="confirmCheck">
                            I confirm that I am authorized to sign this MOU on behalf of my organization.
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="submitButton">Submit MOU</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/upload.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize signature pad
        const canvas = document.getElementById('signatureCanvas');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        // Clear signature button
        document.getElementById('clearSignature').addEventListener('click', function() {
            signaturePad.clear();
        });
        
        // Toggle between draw and upload
        const signatureTypeInputs = document.querySelectorAll('input[name="signature_type"]');
        const signatureDrawContainer = document.getElementById('signatureDrawContainer');
        const signatureUploadContainer = document.getElementById('signatureUploadContainer');
        
        signatureTypeInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.value === 'draw') {
                    signatureDrawContainer.style.display = 'block';
                    signatureUploadContainer.style.display = 'none';
                } else {
                    signatureDrawContainer.style.display = 'none';
                    signatureUploadContainer.style.display = 'block';
                }
            });
        });
        
        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            // If drawing signature, get the data
            if (document.getElementById('signatureDraw').checked) {
                if (signaturePad.isEmpty()) {
                    e.preventDefault();
                    alert('Please provide a signature before submitting.');
                    return false;
                }
                
                // Save signature data to hidden input
                const signatureData = signaturePad.toDataURL();
                document.getElementById('signatureData').value = signatureData;
            } else {
                // If uploading signature, check if file is selected
                if (!document.getElementById('signature_file').files.length) {
                    e.preventDefault();
                    alert('Please upload a signature image before submitting.');
                    return false;
                }
            }
        });
        
        // Resize canvas to fit container
        function resizeCanvas() {
            const container = document.querySelector('.signature-pad-container');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            
            canvas.width = container.offsetWidth;
            canvas.height = 200;
            
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // Clear the canvas
        }
        
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
    });
</script>
{% endblock %}
